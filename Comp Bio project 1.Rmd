---
title: "Project 1"
author: "Celeste Guerrero"
date: "3/16/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Celeste Guerrero cbg928

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r datasets}
# Installing necessary packages
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(cluster)

#Importing data set 1 
Cigarette <- read_excel("C:/Users/celes/Downloads/Cigarette.xlsx")
glimpse(Cigarette)

```
There are 528 observations across 10 variables focused on cigarette consumption in the United States between 1985-1995. 

```{r dataset}
# Import dataset 2 
Produc1 <- read_excel("C:/Users/celes/Downloads/Produc1.xlsx")
glimpse(Produc1)
```
This data set represents the production data from the United States from 1970-1986. There are 816 observations across 11 variables. 


```{r}
#1 Tidying Data
# Wrangling data set 1 by filtering specific years
cigarette1 <- Cigarette %>%  filter(between(year,1985,1986))
cigarette1
```
```{r}
# Wrangling data set 2 for certain variables
produc <- Produc1 %>% filter(between(year,1985,1986))
produc
```
Both data sets were initially tidy, but some data wrangling was done beforehand to make the combination of data sets easier in #2. This includes filtering the same years to allow this to be used as a categorical variable if needed. 

```{r}
#2 Join and Merge Data sets
cig_produc <- produc %>% 
  left_join(cigarette1, by="state")
head(cig_produc)
```
Data set 1 and 2 were combined using a left join by state as pictured above. The join was appropriate because it allowed for further data wrangling in the following steps. 

```{r}
#3 Summary Statistics 

#Selecting ideal variables from combined data set 
cleancigprod <- cig_produc %>% select(state,year.x,year.y,unemp,pop,packpc) %>% arrange(year.x)  #arranged  
head(cleancigprod)
```
The variables selected include state which includes most states of the U.S., year.x and year.y which correspond to produc and cigarette1, respectively. Unemp is the state unemployment rate, pop is the state population and packpc is the number of cigarette packs per capita. 

```{r}
# Observations based on same year across states
yearsim <- cleancigprod %>% mutate(Year = if_else(year.x == year.y, "Equal", "Not Equal")) %>% filter(Year == "Equal") #Creating a variable to filter out the true cases where the years match up 
yearsim
```

```{r}
#Clean data, removing extra variables, renamed
clean <- yearsim %>% select(-Year, -year.y) %>% rename("year"=year.x)
glimpse(clean) #final dataset 
```

```{r}
# New variable representing packs of cigarettes consumed for each state population 
clean1 <- clean %>% mutate(Packsperpop = packpc*pop)
clean1

#Summary statistics overall 
clean1 %>% summarize(mean(unemp), mean(pop), mean(packpc), mean(Packsperpop))
```
These summary statistics represent the overall mean of each variable regardless of state or year in the United States. Therefore, the average unemployment rate across the states between 1985-1986 was 6.99, the mean population was 4934031 people, the mean packs of cigarette consumption per capita was 120, and the mean packs of cigarettes across the population was 584267715.

```{r}
# Summary statistics based on state between 1985-1986
clean1 %>% group_by(state) %>%summarize(mean(pop), mean(unemp), mean(packpc), mean(Packsperpop)) 
```
The summary statistics represent the mean of the numeric variables as shown above, but grouped by state. Therefore, they represent the mean of the variable between 1985 and 1986 per each state. 

```{r}
#Summary Statistics cont 
clean1 %>% group_by(year) %>% summarize(mean(pop), mean(unemp), mean(packpc), mean(Packsperpop)) 
```
These summary statistics describe the means of state population, unemployment rate, packs of cigarettes per capita, and packs of cigarettes per population grouped by the years 1985-1986. They give an idea of the changes that occurred in the U.S. over the years despite state specificity. 
```{r}
 # Correlation Matrix, filtered out non numeric variables
cigproduc1 <- as.data.frame(clean1) %>% select(-state)
head(cigproduc1)

# Correlation matrix
library(corrplot)
cor1 <- cigproduc1 %>% select_if(is.numeric) %>%
cor(cigproduc1, use = "pairwise.complete.obs")
cor1

#Correlation heat map
cor(cor1, use = "pairwise.complete.obs") %>%
  # Save as a data frame
  as.data.frame %>%
  # Convert row names to an explicit variable
  rownames_to_column %>%
  # Pivot so that all correlations appear in the same column
  pivot_longer(-1, names_to = "other_var", values_to = "correlation") %>%
  ggplot(aes(rowname, other_var, fill=correlation)) +
  # Heatmap with geom_tile
  geom_tile() +
  # Change the scale to make the middle appear neutral
  scale_fill_gradient2(low="purple",mid="white",high="pink") +
  # Overlay values
  geom_text(aes(label = round(correlation,2)), color = "black", size = 4)

```
Based on the heat map, there is little to no correlation between the numeric variables in the data frame. The closest correlation is between state unemployment rate and state population with a factor of -0.18 and this will be looked into further. 

```{r}
# Visualizations 
# Plot of unemployment rate and state population colored by state
ggplot(data=clean, mapping = aes(x = unemp, y = pop)) + 
  geom_point(aes(color = state)) +
  theme_bw() + ggtitle("Unemployment rate by State population colored by State") 
```
The visualization above represents the state unemployment rate by the state population colored by the different states. It appears there is no correlation as shown by the matrix, but it shows some interesting findings. States with the highest unemployment rates have low state population while states with high population have the average overall unemployment rate. 

```{r}
# Visualization
clean2 <- clean %>% 
  group_by(year) %>% 
  select(state, packpc, unemp, year) %>%
  summarise(packs = mean(packpc), unemploy = mean(unemp))
clean2


ggplot(clean2, aes(x = year, y = packs)) + geom_bar(stat = "summary", fun = mean, aes(fill = unemploy)) + scale_y_continuous(breaks =seq(0,150,25), name= "Mean packs per capita in 1985") + geom_errorbar(stat = "summary", width = 0.5) + ggtitle("Cigarette packs per capita between 1985-1986 colored by Unemployment rate") 
```
Based on the above visualization, there was a decrease in the mean cigarette pack consumption per capita from 1985-1986 across the United States. There was also a decrease in the unemployment rate across the U.S. regardless of specific state trends. 

```{r}
# Perform k-means/PAM cluster/PCA 
pca <- clean %>%
  # Remove categorical variables
  select(-state) %>%   
  # Scale to 0 mean and unit variance (standardize)
  scale() %>%           
  prcomp()
names(pca)
pca #visualize pca results

head(pca$x) #View rotated data
pca_data <- data.frame(pca$x, State = clean$state) #Groups by State added in
head(pca_data)
# Visualization of PCA 
ggplot(pca_data, aes(x = PC1, y = PC2, color = State)) + 
  geom_point() 
```
There appears to be two clusters of states that are most similar based on the PCA plot above. 

```{r}
pca$rotation
rotation_data <- data.frame(
  pca$rotation, 
  variable = row.names(pca$rotation))
arrow_style <- arrow(length = unit(0.05, "inches"), type = "closed")

 # Visual of the contribution of variables to PC
ggplot(rotation_data) + 
  geom_segment(aes(xend = PC1, yend = PC2), x = 0, y = 0, arrow = arrow_style) + 
  geom_text(aes(x = PC1, y = PC2, label = variable), hjust = 0, size = 3, color = "red") + 
  xlim(-1., 1.25) + 
  ylim(-1., 1.) +
  coord_fixed() 
```
The variables year, unemp and pop influence PC1 more strongly. The variable packpc influences PC2 more strongly based on the above figure. Again, based on the loading plot there is a small angle between unemployment rate and state population which signifies a more positive correlation as opposed to the others. 

```{r}
#Scree plot 
library(tidyverse)
library(cluster)
library(factoextra)
fviz_eig(pca, addlabels = TRUE, ylim = c(0, 70))
```
Based on the scree plot, PCA is not the best fit for the data as there is no steep curve with a plateau seen. 
